#!/usr/bin/env bash

echo "### Pausing service 'jenkins' and removing existing configuration..."
docker service update --detach=false pipeline_jenkins --config-rm pipeline-jobs --config-rm pipeline-config --replicas 0 || exit 1
echo "### Pausing service 'jenkins-slave-1' and removing existing configuration..."
docker service update --detach=false pipeline_jenkins-slave-1 --config-rm pipeline-config --replicas 0 || exit 1
echo "### Pausing service 'jenkins-slave-2' and removing existing configuration..."
docker service update --detach=false pipeline_jenkins-slave-2 --config-rm pipeline-config --replicas 0 || exit 1
echo "### Replacing configuration..."
docker config rm pipeline-jobs
docker config rm pipeline-config
docker config create pipeline-jobs jobs.yaml
docker config create pipeline-config config.yaml
echo "### Updating service 'jenkins' with new configuration and resuming..."
docker service update --detach=false pipeline_jenkins --config-add source=pipeline-jobs,target=/jobs.yaml --config-add source=pipeline-config,target=/config.yaml --replicas 1
echo "### Updating service 'jenkins-slave-1' with new configuration and resuming..."
docker service update --detach=false pipeline_jenkins-slave-1 --config-add source=pipeline-config,target=/config.yaml --replicas 1
echo "### Updating service 'jenkins-slave-2' with new configuration and resuming..."
docker service update --detach=false pipeline_jenkins-slave-2 --config-add source=pipeline-config,target=/config.yaml --replicas 1